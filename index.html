<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Inspeções</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary:#0097CE;
      --primary-dark:#007fb0;
      --bg:#f4f6f8;
      --card:#fff;
      --text:#333;
      --border:#e0e0e0;
      --danger:#b3261e;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);color:var(--text);}

    header{
      background:var(--card);
      padding:16px 24px;
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      position:sticky;top:0;z-index:10;
    }
    header h2{margin:0;color:var(--primary);display:flex;align-items:center;gap:8px;font-size:18px;}
    .top-actions{margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap;}

    input,select{
      padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px;outline:none;
    }

    button,.btn-link{
      padding:9px 14px;border-radius:10px;border:none;cursor:pointer;font-size:14px;
      display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    button{background:var(--primary);color:#fff;}
    button:hover{background:var(--primary-dark);}
    button.secondary,.btn-link{
      background:#fff;color:#333;border:1px solid var(--border);text-decoration:none;
    }
    button.secondary:hover,.btn-link:hover{background:#f3f3f3;}

    main{padding:24px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end;margin-bottom:14px;}
    .status{font-size:14px;color:#555;min-width:240px;flex:1;}
    .status.success{color:#137333;}
    .status.error{color:var(--danger);}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      align-items:stretch;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .pad{padding:14px;}

    .kpi{
      display:flex;flex-direction:column;gap:6px;
      min-height:96px;
    }
    .kpi .label{font-size:12px;color:#666;font-weight:700;}
    .kpi .value{font-size:28px;font-weight:900;line-height:1;}
    .kpi .sub{font-size:12px;color:#777;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-size:13px;color:#444;font-weight:700;
    }

    .divider{height:1px;background:var(--border);margin:12px 0;}

    canvas{width:100%;height:320px;display:block;}

    .chart-title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .chart-title h3{margin:0;color:var(--primary);font-size:16px;}
    .hint{font-size:12px;color:#777;}

    /* tooltip */
    .canvas-tip{
      position: fixed;
      display: none;
      pointer-events: none;
      z-index: 99999;
      background: #111;
      color: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.2;
      white-space: nowrap;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      transform: translate(10px, 10px);
    }
    .canvas-tip b{ font-weight: 900; }
    .canvas-tip .muted{ opacity: .85; font-weight: 600; }

    @media (max-width: 900px){
      .grid > .card{grid-column: span 12 !important;}
    }
  </style>
</head>

<body>
  <header>
    <h2><i class="bi bi-speedometer2"></i> Dashboard - Inspeções</h2>

    <div class="top-actions">
      <a class="btn-link" href="https://coec-epb.github.io/geral_colaboradores/" title="Voltar para Inspeções">
        <i class="bi bi-arrow-left"></i> Inspeções
      </a>
      <button class="secondary" id="btnAtualizar">
        <i class="bi bi-arrow-repeat"></i> Atualizar
      </button>
      <button class="secondary" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Sair
      </button>
    </div>
  </header>

  <main>
    <!-- filtros -->
    <div class="card pad">
      <div class="row">
        <div>
          <div class="hint" style="font-weight:700;margin-bottom:6px;">Mês</div>
          <input id="filtroMes" type="month" style="width:180px;">
        </div>

        <div>
          <div class="hint" style="font-weight:700;margin-bottom:6px;">Regional</div>
          <select id="filtroRegional" style="min-width:180px;">
            <option value="">Todas</option>
            <option value="CENTRO">CENTRO</option>
            <option value="LESTE">LESTE</option>
            <option value="OESTE">OESTE</option>
          </select>
        </div>

        <div style="flex:1;min-width:260px;">
          <div class="hint" style="font-weight:700;margin-bottom:6px;">Supervisor (Líder)</div>
          <select id="filtroSupervisor" style="width:100%;">
            <option value="">Todos</option>
          </select>
        </div>

        <div id="status" class="status"></div>
      </div>

      <div class="divider"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <span class="pill"><i class="bi bi-info-circle"></i> (Inspeções e NC)</span>
        <span class="pill"><i class="bi bi-people"></i> Abrangência usa inspeções reais + ranking-colaboradores</span>
        <span class="pill"><i class="bi bi-graph-up"></i> Frequência semanal</span>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid" style="margin-top:12px;">
      <div class="card pad" style="grid-column: span 4;">
        <div class="kpi">
          <div class="label">Qtd. Inspeções (mês)</div>
          <div class="value" id="kpiInspecoes">0</div>
          <div class="sub" id="kpiInspecoesSub">—</div>
        </div>
      </div>

      <div class="card pad" style="grid-column: span 4;">
        <div class="kpi">
          <div class="label">Qtd. Não Conformidades (mês)</div>
          <div class="value" id="kpiNC">0</div>
          <div class="sub" id="kpiNCSub">—</div>
        </div>
      </div>

      <div class="card pad" style="grid-column: span 4;">
       <div class="kpi">
    <div class="label">Abrangência</div>
    <div class="value" id="kpiAbrangencia">0%</div>
    <div class="sub" id="kpiAbrangenciaSub">0 inspecionados / 0 total</div>
    <div class="sub" id="kpiAbrangenciaPrazo">—</div>
  </div>
</div>
    </div>

    <!-- Gráficos -->
    <div class="grid" style="margin-top:12px;">
      <div class="card pad" style="grid-column: span 6;">
        <div class="chart-title">
          <h3><i class="bi bi-graph-up"></i> Frequência semanal (mês)</h3>
          <div class="hint">Conta participações do gestor (lider/auditor/cadastrante)</div>
        </div>
        <div style="margin-top:10px;">
          <canvas id="cvFrequencia"></canvas>
        </div>
      </div>

      <div class="card pad" style="grid-column: span 6;">
        <div class="chart-title">
          <h3><i class="bi bi-bar-chart"></i> Inspeções x NC por mês (ano)</h3>
          <div class="hint">Dados do <b>/stats-mensal</b> no ano do mês selecionado</div>
        </div>
        <div style="margin-top:10px;">
          <canvas id="cvAno"></canvas>
        </div>
      </div>
    </div>
  </main>

  <!-- tooltip -->
  <div id="canvasTooltip" class="canvas-tip"></div>

<script>
/* ============================
   CONFIG / SESSÃO
============================ */
const API = "https://inspecoes.pedro-fillype.workers.dev";

  function formatarDataBR(iso){
  // iso yyyy-mm-dd
  const s = String(iso || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return s || "-";
  const [y,m,d] = s.split("-");
  return `${d}/${m}/${y}`;
}

function addMonths(dateObj, months){
  const d = new Date(dateObj.getTime());
  const day = d.getDate();
  d.setMonth(d.getMonth() + Number(months || 0));

  // ajuste para meses menores (ex: 31 -> 30/28)
  if (d.getDate() < day) d.setDate(0);
  return d;
}

function diffDays(a, b){
  // diferença em dias inteiros entre datas (b - a)
  const ms = b.getTime() - a.getTime();
  return Math.ceil(ms / (1000 * 60 * 60 * 24));
}

function logout(){
  localStorage.removeItem("logado");
  localStorage.removeItem("token");
  localStorage.removeItem("perfil");
  localStorage.removeItem("lider");
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}

if (localStorage.getItem("logado") !== "true") logout();
const token = String(localStorage.getItem("token") || "").trim();
if (!token) logout();

function setStatus(msg, type=""){
  const el = document.getElementById("status");
  if (!el) return;
  el.textContent = msg;
  el.className = "status " + (type || "");
}

async function apiFetch(path, options={}){
  return fetch(`${API}${path}`, {
    ...options,
    headers: {
      Authorization: `Bearer ${token}`,
      ...(options.headers || {})
    }
  });
}

/* ============================
   TOKEN HELPERS (compat)
============================ */
function b64urlToString(b64url) {
  try {
    let b64 = String(b64url || "").replace(/-/g, "+").replace(/_/g, "/");
    while (b64.length % 4) b64 += "=";
    return atob(b64);
  } catch { return ""; }
}

function decodeTokenPayloadCompat(token) {
  try {
    const parts = String(token || "").split(".");
    if (parts.length < 2) return null;

    const maybeWorkerBody = parts[0];
    const maybeJwtPayload = parts[1];

    const workerJson = b64urlToString(maybeWorkerBody);
    if (workerJson && workerJson.trim().startsWith("{")) return JSON.parse(workerJson);

    const jwtJson = b64urlToString(maybeJwtPayload);
    if (jwtJson && jwtJson.trim().startsWith("{")) return JSON.parse(jwtJson);

    return null;
  } catch { return null; }
}

function getNomeDoToken(){
  const lsLider = String(localStorage.getItem("lider") || "").trim();
  if (lsLider) return lsLider;

  const payload = decodeTokenPayloadCompat(token);
  if (!payload) return "";
  return String(payload.lider || payload.nome || payload.name || "").trim();
}

function normName(s){
  return String(s || "")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ").trim().toUpperCase();
}

/* ============================
   MAPA LÍDER -> REGIONAL
============================ */
const REGIONAL_POR_LIDER = {
  "ANDERSON DE ARAUJO VASCONCELOS": "CENTRO",
  "EDEVALDO FELICIANO DA SILVA": "CENTRO",
  "ALEXANDRE BATISTA DIAS": "OESTE",
  "DAVIDSON DA SILVA GOMES": "CENTRO",
  "THOMAZ CHAVES DO NASCIMENTO": "LESTE",
  "WESLEY FERNANDES DE SOUZA": "LESTE",
  "JANSEN LACERDA DE OLIVEIRA JUNIOR": "OESTE",
  "FABIANO OLIVEIRA DE MENEZES": "OESTE",
  "CRISTIANO CAETANO MADEIRO": "OESTE",
  "NATHALIA HOLANDA VILHENA": "LESTE",
  "EDIVALDO DA SILVA BRANDAO NETO": "LESTE",
  "RENAN IGOR MENEZES DA SILVA": "CENTRO",
  "MACIEL GOMES DE AGUIAR": "CENTRO",
  "DELMIR BARBOSA MAXIMIANO": "LESTE",
  "FABIO LIMA DE FRANCA": "LESTE",
  "YURI VILMAR BATISTA MELO": "LESTE",
  "MARCONE HENRIQUE DA CRUZ": "OESTE",
  "RENATO LINS DE VASCONCELOS NETO": "LESTE",
  "FABRICIO ANDRE SILVA DE ARAUJO": "LESTE",
  "GERALDO PEDRO DA SILVA JUNIOR": "LESTE",
  "RICHARDSON SILVA DE OLIVEIRA": "LESTE"
};

function isInRegionalByLiderNome(liderNome, regional){
  if (!regional) return true;
  const reg = REGIONAL_POR_LIDER[String(liderNome||"").trim()] || "";
  return reg === regional;
}

/* ============================
   DATAS
============================ */
function mesAtualYYYYMM(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}

function mesToRange(mesYYYYMM){
  const [y, m] = String(mesYYYYMM || "").split("-");
  if (!y || !m) return { ini:"", fim:"", ano:"", mm:"" };

  const year = Number(y);
  const month = Number(m); // 1..12
  const lastDay = new Date(year, month, 0).getDate();

  return {
    ini: `${y}-${m}-01`,
    fim: `${y}-${m}-${String(lastDay).padStart(2, "0")}`,
    ano: y,
    mm: m
  };
}

function parseISODateFlex(v){
  const s = String(v||"").trim();
  if (!s) return null;
  const iso = s.slice(0,10);
  const dt = new Date(`${iso}T00:00:00`);
  return isNaN(dt.getTime()) ? null : dt;
}

function weekOfMonth(d){
  return Math.floor((d.getDate()-1)/7)+1; // 1..5
}

/* ============================
   FETCHERS
============================ */
async function fetchLideres(){
  const res = await apiFetch(`/lideres`);
  const text = await res.text();
  if (!res.ok) throw new Error(text);
  const data = JSON.parse(text);
  return Array.isArray(data) ? data : (data.results || []);
}

async function fetchStatsMensal(ano, lider){
  const qs = new URLSearchParams();
  if (ano) qs.set("ano", ano);
  if (lider) qs.set("lider", lider);

  const res = await apiFetch(`/stats-mensal?${qs.toString()}`);
  const text = await res.text();
  if (!res.ok) throw new Error(text);
  return JSON.parse(text);
}

async function fetchFrequencia(mes, gestor){
  const qs = new URLSearchParams();
  qs.set("mes", mes);
  qs.set("gestor", gestor);

  const res = await apiFetch(`/frequencia?${qs.toString()}`);
  const text = await res.text();
  if (!res.ok) throw new Error(text);
  return JSON.parse(text); // {weeks,total}
}

async function fetchInspecoesRange(ini, fim, lider){
  const qs = new URLSearchParams();
  if (ini) qs.set("data_ini", ini);
  if (fim) qs.set("data_fim", fim);
  if (lider) qs.set("lider", lider); // importante: seu /inspecoes filtra por participação

  const res = await apiFetch(`/inspecoes?${qs.toString()}`);
  const text = await res.text();
  if (!res.ok) throw new Error(text);

  const data = JSON.parse(text);
  return Array.isArray(data) ? data : (data.results || []);
}

async function fetchRankingColaboradores(){
  const res = await apiFetch(`/ranking-colaboradores`);
  const text = await res.text();
  if (!res.ok) throw new Error(text);
  const data = JSON.parse(text);
  return Array.isArray(data.results) ? data.results : [];
}

/* ============================
   ABRANGÊNCIA
============================ */
function splitNomesCampo(v){
  const s = String(v||"").trim();
  if (!s) return [];
  return s.split(/[,;|]/g).map(x => x.trim()).filter(Boolean);
}

function calcAbrangencia(inspecoesFiltradas, rankingFiltrado){
  const totalSet = new Set();
  (rankingFiltrado || []).forEach(r=>{
    const nome = String(r.colaborador || "").trim();
    if (nome) totalSet.add(normName(nome));
  });

  const inspSet = new Set();
  (inspecoesFiltradas || []).forEach(i=>{
    splitNomesCampo(i.auditados).forEach(n => inspSet.add(normName(n)));
    splitNomesCampo(i.colaborador_1).forEach(n => inspSet.add(normName(n)));
    splitNomesCampo(i.colaborador_2).forEach(n => inspSet.add(normName(n)));
    splitNomesCampo(i.colaborador_3).forEach(n => inspSet.add(normName(n)));
    splitNomesCampo(i.colaborador_4).forEach(n => inspSet.add(normName(n)));
    splitNomesCampo(i.colaborador_5).forEach(n => inspSet.add(normName(n)));
  });

  const total = totalSet.size;
  const inspecionados = [...inspSet].filter(n => totalSet.has(n)).length;
  const pct = total > 0 ? (inspecionados / total) * 100 : 0;

  return { total, inspecionados, pct };
}

/* ============================
   TOOLTIP (Canvas)
============================ */
function getTooltipEl(){ return document.getElementById("canvasTooltip"); }

function showTip(text, clientX, clientY){
  const tip = getTooltipEl();
  if (!tip) return;
  tip.innerHTML = text;
  tip.style.display = "block";

  const pad = 12;
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  let x = clientX + pad;
  let y = clientY + pad;

  tip.style.left = x + "px";
  tip.style.top  = y + "px";

  const r = tip.getBoundingClientRect();
  if (r.right > vw - 8) x = clientX - r.width - pad;
  if (r.bottom > vh - 8) y = clientY - r.height - pad;

  tip.style.left = x + "px";
  tip.style.top  = y + "px";
}

function hideTip(){
  const tip = getTooltipEl();
  if (!tip) return;
  tip.style.display = "none";
}

function attachCanvasTooltip(canvas){
  if (!canvas) return;
  if (canvas._tooltipBound) return;
  canvas._tooltipBound = true;

  canvas.addEventListener("mousemove", (ev) => {
    const rect = canvas.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;

    const bars = canvas._bars || [];
    let hit = null;

    for (let i = bars.length - 1; i >= 0; i--){
      const b = bars[i];
      if (x >= b.x && x <= b.x + b.w && y >= b.y && y <= b.y + b.h){
        hit = b; break;
      }
    }

    if (!hit) return hideTip();

    showTip(
      `<div class="muted">${hit.group}</div><div><b>${hit.series}</b>: ${hit.value}</div>`,
      ev.clientX, ev.clientY
    );
  });

  canvas.addEventListener("mouseleave", hideTip);
  window.addEventListener("scroll", hideTip, { passive:true });
}

/* ============================
   GRÁFICOS (Canvas com tooltip)
============================ */
function drawBars(canvas, labels, valuesA, valuesB, labelA="A", labelB="B"){
  const ctx = canvas.getContext("2d");

  const W = canvas.clientWidth || 900;
  const H = canvas.clientHeight || 320;
  canvas.width = W;
  canvas.height = H;

  ctx.clearRect(0,0,W,H);

  const pad = 40;
  const chartW = W - pad*2;
  const chartH = H - pad*2;

  const maxV = Math.max(1, ...valuesA, ...valuesB);
  const cols = labels.length;

  canvas._bars = [];

  // eixos
  ctx.strokeStyle = "#ddd";
  ctx.beginPath();
  ctx.moveTo(pad, pad);
  ctx.lineTo(pad, H-pad);
  ctx.lineTo(W-pad, H-pad);
  ctx.stroke();

  // grid
  ctx.fillStyle = "#666";
  ctx.font = "12px Segoe UI, Arial";
  const steps = 4;
  for(let s=0;s<=steps;s++){
    const v = (maxV/steps)*s;
    const y = (H-pad) - (v/maxV)*chartH;
    ctx.strokeStyle="#efefef";
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(W-pad, y);
    ctx.stroke();
    ctx.fillStyle="#666";
    ctx.fillText(String(Math.round(v)), 8, y+4);
  }

  const groupW = chartW / cols;
  const barW = Math.max(10, Math.min(18, groupW/4));
  const gap = barW;

  for(let i=0;i<cols;i++){
    const x0 = pad + i*groupW + (groupW - (barW*2 + gap))/2;

    const a = Number(valuesA[i] ?? 0);
    const b = Number(valuesB[i] ?? 0);

    const hA = (a/maxV)*chartH;
    const hB = (b/maxV)*chartH;

    const yA = (H-pad)-hA;
    const yB = (H-pad)-hB;

    // A
    ctx.fillStyle = "rgba(0,151,206,.25)";
    ctx.strokeStyle = "rgba(0,151,206,.35)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.rect(x0, yA, barW, hA);
    ctx.fill(); ctx.stroke();

    canvas._bars.push({ x:x0, y:yA, w:barW, h:hA, group: labels[i], series: labelA, value: a });

    // B
    if (labelB){
      ctx.fillStyle = "rgba(255,99,71,.25)";
      ctx.strokeStyle = "rgba(255,99,71,.35)";
      ctx.beginPath();
      ctx.rect(x0+barW+gap, yB, barW, hB);
      ctx.fill(); ctx.stroke();

      canvas._bars.push({ x:x0+barW+gap, y:yB, w:barW, h:hB, group: labels[i], series: labelB, value: b });
    }

    ctx.fillStyle="#555";
    ctx.fillText(labels[i], pad + i*groupW + 6, H - pad + 18);
  }

  attachCanvasTooltip(canvas);
}

function drawWeeks(canvas, weeks){
  const labels = ["S1","S2","S3","S4","S5"];
  drawBars(canvas, labels, weeks, [0,0,0,0,0], "Inspeções", "");
}

function nomeMes(mm){
  const map = {"01":"Jan","02":"Fev","03":"Mar","04":"Abr","05":"Mai","06":"Jun","07":"Jul","08":"Ago","09":"Set","10":"Out","11":"Nov","12":"Dez"};
  return map[mm] || mm;
}

/* ============================
   SELECTS
============================ */
function getGestoresDoMapa(regionalSelecionada = ""){
  const lideres = Object.keys(REGIONAL_POR_LIDER || {});

  // se escolheu regional, filtra só os gestores daquela regional
  const filtrados = regionalSelecionada
    ? lideres.filter(l => (REGIONAL_POR_LIDER[l] || "") === regionalSelecionada)
    : lideres;

  // ordena bonitinho
  return filtrados.sort((a,b)=> normName(a).localeCompare(normName(b)));
}

async function carregarSupervisoresNoSelect(){
  const sel = document.getElementById("filtroSupervisor");
  if (!sel) return;

  const regional = document.getElementById("filtroRegional")?.value || "";

  const lideres = getGestoresDoMapa(regional);

  const valorAtual = sel.value || "";
  sel.innerHTML =
    `<option value="">Todos</option>` +
    lideres.map(l => `<option value="${String(l).replaceAll('"',"&quot;")}">${l}</option>`).join("");

  // tenta manter o selecionado (se ainda existir)
  if (valorAtual && lideres.some(x => normName(x) === normName(valorAtual))){
    sel.value = valorAtual;
  } else {
    // se não, tenta setar o próprio usuário
    const meu = normName(getNomeDoToken());
    const found = lideres.find(x => normName(x) === meu);
    if (found) sel.value = found;
  }
}
/* ============================
   DASHBOARD CORE
============================ */
async function atualizarDashboard(){
  async function atualizarDashboard(){
  try{
    setStatus("Carregando dados...", "");

    const mes = document.getElementById("filtroMes")?.value || mesAtualYYYYMM();
    const regional = document.getElementById("filtroRegional")?.value || "";
    const supervisor = document.getElementById("filtroSupervisor")?.value || "";

    const { ini, fim, ano, mm } = mesToRange(mes);

    // ========= 1) KPIs + gráfico do ano (OFICIAL: /stats-mensal)
    // Obs: se supervisor vazio => "geral" (admin/super vê geral; user normal o Worker força pra ele)
    // ========= 1) KPIs + gráfico do ano (OFICIAL: /stats-mensal)
// Pega SEM supervisor para não “igualar” por causa do backend
// ========= 1) KPIs do mês (via inspeções reais)

// pega inspeções do mês JÁ FILTRADAS por participação do supervisor (lider/auditor/cadastrante)
const inspecoesMesBase = await fetchInspecoesRange(ini, fim, supervisor || "");

// helper pra descobrir "quem é o líder" do registro (pra regional)
function getNomeLiderInspecao(i){
  return String(
    i.lider ??
    i.gestor_imediato ??
    i.supervisor ??
    i.gestor ??
    ""
  ).trim();
}

// aplica regional (se selecionado)
const inspecoesMesFiltradas = !regional
  ? inspecoesMesBase
  : inspecoesMesBase.filter(i => isInRegionalByLiderNome(getNomeLiderInspecao(i), regional));

// total inspeções do mês
const totalInspecoesMes = inspecoesMesFiltradas.length;

// soma NC do mês (tentando vários campos)
function getNC(i){
  const cand = [
    i.qtd_nc,
    i.qtd_nao_conformidade,
    i.nao_conformidades,
    i.nao_conforme,
    i.nc,
    i.total_nc
  ];
  for (const v of cand){
    const n = Number(v);
    if (Number.isFinite(n)) return n;
  }
  if (Array.isArray(i.nao_conformidade_itens)) return i.nao_conformidade_itens.length;
  return 0;
}
const totalNCMes = inspecoesMesFiltradas.reduce((acc, i) => acc + getNC(i), 0);

// aplica nos KPIs
document.getElementById("kpiInspecoes").textContent = totalInspecoesMes;
document.getElementById("kpiNC").textContent = totalNCMes;

document.getElementById("kpiInspecoesSub").textContent =
  supervisor ? `Supervisor: ${supervisor}` :
  (regional ? `Regional: ${regional} (parcial*)` : "Geral");

document.getElementById("kpiNCSub").textContent =
  `Escopo do mês ${mes} • (via inspeções reais)`;

    try {
  const statsAno = await fetchStatsMensal(ano, ""); // geral

  const labelsAno = ["01","02","03","04","05","06","07","08","09","10","11","12"].map(nomeMes);

  // garante 12 posições mesmo se vier faltando mês
  const porMesMap = new Map();
  (statsAno.por_mes || []).forEach(r => {
    const k = String(r.mes || "").padStart(2, "0");
    porMesMap.set(k, r);
  });

  const insAno = [];
  const ncAno  = [];

  for (const m2 of ["01","02","03","04","05","06","07","08","09","10","11","12"]) {
    const r2 = porMesMap.get(m2) || {};
    insAno.push(Number(r2.total || 0));
    ncAno.push(Number(r2.soma_nao_conforme || 0));
  }

  const cvAno = document.getElementById("cvAno");
  if (cvAno) {
    drawBars(cvAno, labelsAno, insAno, ncAno, "Inspeções", "NC");
  } else {
    console.warn("Canvas cvAno não encontrado");
  }
} catch (e) {
  console.error("Erro ao desenhar gráfico do ano:", e);
}


    // ========= 2) Frequência semanal (OFICIAL: /frequencia)
    // /frequencia exige gestor. Se "Todos", não dá (precisa endpoint agregador).
    if (supervisor){
      const freq = await fetchFrequencia(mes, supervisor);
      const weeks = Array.isArray(freq.weeks) ? freq.weeks : [0,0,0,0,0];
      drawWeeks(document.getElementById("cvFrequencia"), weeks);
    } else {
      drawWeeks(document.getElementById("cvFrequencia"), [0,0,0,0,0]);
    }

    // ========= 3) Abrangência (ANUAL)
    // pega ano inteiro do ano do mês selecionado
    const iniAno = `${ano}-01-01`;
    const fimAno = `${ano}-12-31`;

    // inspeções do ano (não do mês)
    const inspecoesAno = await fetchInspecoesRange(iniAno, fimAno, supervisor);

    // filtro regional no front
    const inspecoesAnoRegional = !regional
      ? inspecoesAno
      : inspecoesAno.filter(i => isInRegionalByLiderNome(i.lider, regional));

    // ranking do time (continua igual)
    const ranking = await fetchRankingColaboradores();

    const rankingFiltrado = (ranking || []).filter(r=>{
      const liderR = String(r.lider||"").trim();
      if (regional && !isInRegionalByLiderNome(liderR, regional)) return false;
      if (supervisor && normName(liderR) !== normName(supervisor)) return false;
      return true;
    });

    // abrangência anual
    const ab = calcAbrangencia(inspecoesAnoRegional, rankingFiltrado);

    document.getElementById("kpiAbrangencia").textContent =
      `${ab.pct.toFixed(1).replace(".",",")}%`;

    const faltamColabs = Math.max(0, ab.total - ab.inspecionados);

    document.getElementById("kpiAbrangenciaSub").textContent =
      `${ab.inspecionados} inspecionados / ${ab.total} total • Faltam: ${faltamColabs}`;

    // ---- Prazo fixo: começa 03/02/2026 e dura 4 meses ----
    const inicioPrazo = new Date("2026-02-03T00:00:00");
    const fimPrazo = addMonths(inicioPrazo, 4); // 4 meses depois

    const hoje = new Date();
    const diasTotais = Math.max(0, diffDays(inicioPrazo, fimPrazo));
    const diasRestantes = Math.max(0, diffDays(hoje, fimPrazo));

    const elPrazo = document.getElementById("kpiAbrangenciaPrazo");
    if (elPrazo) {
      elPrazo.textContent =
        `Prazo: ${diasRestantes} dia(s) restantes • até ${formatarDataBR(fimPrazo.toISOString().slice(0,10))} (total ${diasTotais} dias)`;
    }

    setStatus(`Dashboard atualizado • Mês ${mes}`, "success");
  } catch(e){
    console.error(e);
    setStatus("Erro ao carregar dashboard (veja o console).", "error");
  }
}

/* ============================
   INIT
============================ */
(function init(){
  const mesEl = document.getElementById("filtroMes");
  if (mesEl && !mesEl.value) mesEl.value = mesAtualYYYYMM();

  carregarSupervisoresNoSelect();

  document.getElementById("btnAtualizar")?.addEventListener("click", atualizarDashboard);
  document.getElementById("filtroMes")?.addEventListener("change", atualizarDashboard);
  document.getElementById("filtroRegional")?.addEventListener("change", () => {
  carregarSupervisoresNoSelect();   // ✅ refaz a lista conforme a regional
  atualizarDashboard();            // ✅ aplica filtros
});
  document.getElementById("filtroSupervisor")?.addEventListener("change", atualizarDashboard);

  atualizarDashboard();
})();
</script>

</body>
</html>
